<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swim Check - Motivational Time Tracker</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        /* Custom styles */
        .time-value {
            font-family: 'Courier New', monospace;
            text-align: center;
        }

        .button-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .button-group button {
            flex: 1;
            min-width: 80px;
        }

        /* Reduce padding for gender and course type buttons to prevent wrapping */
        #genderButtons button,
        #courseButtons button {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
            min-width: 60px;
        }

        .button-group button.active {
            background-color: var(--pico-primary-background);
            border-color: var(--pico-primary-border);
        }

        .event-grid {
            overflow-x: auto;
            margin-bottom: 2rem;
        }

        .event-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .event-table th,
        .event-table td {
            padding: 0.5rem;
            border: 1px solid var(--pico-muted-border-color);
        }

        .event-table th {
            text-align: center;
            background-color: var(--pico-background-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .event-table td {
            text-align: center;
        }

        .event-table td:first-child {
            text-align: left;
            font-weight: 500;
        }

        .time-input {
            width: 100%;
            min-width: 120px;
            font-family: 'Courier New', monospace;
            text-align: center;
            padding: 0.5rem;
            margin: 0;
            transition: all 0.3s ease;
        }

        /* Input border colors when standards are met */
        tr.has-value.met-a .time-input {
            border: 3px solid #28a745;
        }

        tr.has-value.met-b-plus .time-input {
            border: 3px solid #17a2b8;
        }

        tr.has-value.met-b .time-input {
            border: 3px solid #ffc107;
        }

        /* Row with entered value gets light gray background on all cells */
        .event-table tr.has-value td {
            background-color: rgba(128, 128, 128, 0.15);
            transition: background-color 0.3s ease;
        }

        /* Standard cells */
        .standard-cell {
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }

        /* Highlight standards when met - these override the row gray background */
        .standard-cell.met {
            font-weight: 700;
            border-width: 2px;
        }

        .standard-cell.met-a {
            background-color: #28a745 !important;
            color: white;
            border-color: #1e7e34;
        }

        .standard-cell.met-b-plus {
            background-color: #17a2b8 !important;
            color: white;
            border-color: #117a8b;
        }

        .standard-cell.met-b {
            background-color: #ffc107 !important;
            color: #856404;
            border-color: #d39e00;
        }

        .app-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .season-info {
            font-size: 0.9rem;
            color: var(--pico-muted-color);
            margin-bottom: 2rem;
        }

        select {
            margin-bottom: 1rem;
        }

        .note-text {
            font-size: 0.85rem;
            font-style: italic;
            color: var(--pico-muted-color);
            margin-top: 0.5rem;
        }

        .clear-section {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--pico-muted-border-color);
        }

        /* Footer */
        .app-footer {
            text-align: center;
            margin-top: 3rem;
            padding: 2rem 0 1rem 0;
            border-top: 1px solid var(--pico-muted-border-color);
            color: var(--pico-muted-color);
            font-size: 0.9rem;
        }

        .footer-phrase {
            margin-bottom: 1.5rem;
        }

        .footer-phrase .heart {
            color: #dc3545;
        }

        .footer-support {
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .footer-support a {
            color: var(--pico-primary);
            text-decoration: none;
        }

        .footer-support a:hover {
            text-decoration: underline;
        }

        .footer-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

    </style>
</head>
<body>
    <main class="container">
        <div class="app-header">
            <h1>Swim Check üèä</h1>
            <p class="season-info" id="seasonInfo">Loading...</p>
        </div>

        <!-- Controls Section -->
        <section>
            <label for="ageGroupSelect">Age Group</label>
            <select id="ageGroupSelect" aria-label="Select age group">
                <option value="">Select Age Group</option>
            </select>

            <label>Gender</label>
            <div class="button-group" id="genderButtons" role="group" aria-label="Select gender">
            </div>

            <label>Course Type</label>
            <div class="button-group" id="courseButtons" role="group" aria-label="Select course type">
                <button type="button" class="secondary" data-course="SCY">SCY</button>
                <button type="button" class="secondary" data-course="SCM">SCM</button>
                <button type="button" class="secondary" data-course="LCM">LCM</button>
            </div>

            <div id="noteDisplay" class="note-text"></div>
        </section>

        <!-- Event Grid Section -->
        <section class="event-grid">
            <div id="eventsContainer">
                <p style="text-align: center; color: var(--pico-muted-color);">
                    Please select age group, gender, and course type to view events.
                </p>
            </div>
        </section>

        <!-- Clear Times Section -->
        <section class="clear-section">
            <button type="button" id="clearTimesBtn" class="secondary">Clear All Times</button>
        </section>

        <!-- Footer -->
        <footer class="app-footer">
            <p class="footer-phrase" id="footerPhrase">Made with <span class="heart">‚ù§Ô∏è</span> in war-torn PDX</p>
            <div class="footer-support">
                <p>Do you find Swim Check useful?<br>Consider <a href="https://github.com/ironprogrammer/swimcheck" target="_blank" rel="noopener noreferrer">contributing on GitHub</a> or buying me a coffee!</p>
            </div>
            <div class="footer-buttons">
                <iframe src="https://ghbtns.com/github-btn.html?user=ironprogrammer&repo=swimcheck&type=star&count=true&size=large" frameborder="0" scrolling="0" width="170" height="30" title="GitHub"></iframe>
                <a href="https://www.buymeacoffee.com/ironprogrammer" target="_blank"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a>
            </div>
        </footer>
    </main>

    <script>
        // App state
        let swimData = null;
        let appState = {
            ageGroup: null,
            gender: null,
            courseType: 'SCY',
            times: {}
        };

        // Load JSON data
        async function loadData() {
            try {
                const response = await fetch('swim_time_standards.json');
                swimData = await response.json();
                document.getElementById('seasonInfo').textContent = swimData.title;
                initializeApp();
            } catch (error) {
                console.error('Failed to load swim data:', error);
                document.getElementById('seasonInfo').textContent = 'Error loading data';
            }
        }

        // Initialize the app
        function initializeApp() {
            loadStateFromStorage();
            populateAgeGroups();
            populateGenderButtons();
            setupEventListeners();
            renderEvents();
        }

        // Local storage functions
        function saveStateToStorage() {
            localStorage.setItem('swimCheckState', JSON.stringify(appState));
        }

        function loadStateFromStorage() {
            const saved = localStorage.getItem('swimCheckState');
            if (saved) {
                const parsed = JSON.parse(saved);
                appState = { ...appState, ...parsed };
            }
        }

        // Populate age groups dropdown
        function populateAgeGroups() {
            const select = document.getElementById('ageGroupSelect');
            swimData.ageGroups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.age;
                option.textContent = group.age;
                select.appendChild(option);
            });

            if (appState.ageGroup) {
                select.value = appState.ageGroup;
            }
        }

        // Populate gender buttons
        function populateGenderButtons() {
            const container = document.getElementById('genderButtons');
            const genders = new Set();

            swimData.ageGroups.forEach(group => {
                Object.keys(group.genders).forEach(gender => genders.add(gender));
            });

            genders.forEach(gender => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'secondary';
                button.textContent = gender;
                button.dataset.gender = gender;
                if (appState.gender === gender) {
                    button.classList.add('active');
                    button.classList.remove('secondary');
                }
                container.appendChild(button);
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Age group selection
            document.getElementById('ageGroupSelect').addEventListener('change', (e) => {
                appState.ageGroup = e.target.value;
                saveStateToStorage();
                renderEvents();
            });

            // Gender buttons
            document.getElementById('genderButtons').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#genderButtons button').forEach(btn => {
                        btn.classList.remove('active');
                        btn.classList.add('secondary');
                    });
                    e.target.classList.add('active');
                    e.target.classList.remove('secondary');
                    appState.gender = e.target.dataset.gender;
                    saveStateToStorage();
                    renderEvents();
                }
            });

            // Course type buttons
            document.getElementById('courseButtons').addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    document.querySelectorAll('#courseButtons button').forEach(btn => {
                        btn.classList.remove('active');
                        btn.classList.add('secondary');
                    });
                    e.target.classList.add('active');
                    e.target.classList.remove('secondary');
                    appState.courseType = e.target.dataset.course;
                    saveStateToStorage();
                    renderEvents();
                }
            });

            // Set initial course button active state
            if (appState.courseType) {
                const courseBtn = document.querySelector(`[data-course="${appState.courseType}"]`);
                if (courseBtn) {
                    courseBtn.classList.add('active');
                    courseBtn.classList.remove('secondary');
                }
            }

            // Clear times button
            document.getElementById('clearTimesBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all entered times? This cannot be undone.')) {
                    appState.times = {};
                    saveStateToStorage();
                    renderEvents();
                }
            });
        }

        // Render events table
        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            const noteDisplay = document.getElementById('noteDisplay');
            noteDisplay.textContent = '';

            if (!appState.ageGroup || !appState.gender || !appState.courseType) {
                container.innerHTML = '<p style="text-align: center; color: var(--pico-muted-color);">Please select age group, gender, and course type to view events.</p>';
                return;
            }

            const ageGroupData = swimData.ageGroups.find(g => g.age === appState.ageGroup);
            if (!ageGroupData || !ageGroupData.genders[appState.gender]) {
                container.innerHTML = '<p style="text-align: center; color: var(--pico-muted-color);">No events found for selected criteria.</p>';
                return;
            }

            // Display note if exists
            if (ageGroupData.note) {
                noteDisplay.textContent = ageGroupData.note;
            }

            const events = ageGroupData.genders[appState.gender].events;
            const course = appState.courseType;

            let tableHTML = `
                <table class="event-table">
                    <thead>
                        <tr>
                            <th>Event</th>
                            <th>Time</th>
                            <th>A</th>
                            <th>B+</th>
                            <th>B</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            events.forEach((event, index) => {
                const times = event[course];

                // Skip events with no times for this course
                if (!times || (times.A === null && times['B+'] === null && times.B === null)) {
                    return;
                }

                const eventKey = `${appState.ageGroup}_${appState.gender}_${course}_${event.name}`;
                const userTime = appState.times[eventKey] || '';
                const qualification = userTime ? getQualification(userTime, times) : null;

                // Add 'has-value' class to row if user has entered a time
                // Add met class to row for input border styling
                let rowClass = userTime ? 'has-value' : '';
                if (qualification === 'a') {
                    rowClass += ' met-a';
                } else if (qualification === 'b-plus') {
                    rowClass += ' met-b-plus';
                } else if (qualification === 'b') {
                    rowClass += ' met-b';
                }

                // Determine standard cell classes
                const aClass = qualification === 'a' ? 'standard-cell met met-a' : 'standard-cell';
                const bPlusClass = qualification === 'b-plus' ? 'standard-cell met met-b-plus' : 'standard-cell';
                const bClass = qualification === 'b' ? 'standard-cell met met-b' : 'standard-cell';

                tableHTML += `
                    <tr class="${rowClass}">
                        <td>${event.name}</td>
                        <td>
                            <input
                                type="text"
                                class="time-input"
                                placeholder="mm:ss.ms"
                                data-event-key="${eventKey}"
                                value="${userTime}"
                                aria-label="Enter time for ${event.name}"
                            >
                        </td>
                        <td class="${aClass} time-value" data-standard="a" data-event-key="${eventKey}">
                            ${times.A || 'n/a'}
                        </td>
                        <td class="${bPlusClass} time-value" data-standard="b-plus" data-event-key="${eventKey}">
                            ${times['B+'] || 'n/a'}
                        </td>
                        <td class="${bClass} time-value" data-standard="b" data-event-key="${eventKey}">
                            ${times.B || 'n/a'}
                        </td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;

            // Setup time input handlers
            setupTimeInputHandlers();
        }

        // Setup time input event handlers
        function setupTimeInputHandlers() {
            const inputs = document.querySelectorAll('.time-input');

            inputs.forEach(input => {
                let timeout;

                input.addEventListener('input', (e) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => {
                        handleTimeInput(e.target);
                    }, 500);
                });

                input.addEventListener('blur', (e) => {
                    clearTimeout(timeout);
                    handleTimeInput(e.target);
                });
            });
        }

        // Handle time input
        function handleTimeInput(input) {
            const eventKey = input.dataset.eventKey;
            const value = input.value.trim();

            if (value) {
                appState.times[eventKey] = value;
            } else {
                delete appState.times[eventKey];
            }

            saveStateToStorage();
            updateStandardHighlighting(input);
        }

        // Update standard cell highlighting
        function updateStandardHighlighting(input) {
            const eventKey = input.dataset.eventKey;
            const value = input.value.trim();

            // Find the row
            const row = input.closest('tr');

            // Get all standard cells in this row
            const standardCells = row.querySelectorAll('.standard-cell');

            // Remove all highlight classes from standard cells
            standardCells.forEach(cell => {
                cell.classList.remove('met', 'met-a', 'met-b-plus', 'met-b');
            });

            // Remove qualification classes from row
            row.classList.remove('met-a', 'met-b-plus', 'met-b');

            // Add or remove 'has-value' class on row based on input
            if (value) {
                row.classList.add('has-value');
            } else {
                row.classList.remove('has-value');
                return;
            }

            // Find the event's times
            const [age, gender, course, eventName] = eventKey.split('_');
            const ageGroupData = swimData.ageGroups.find(g => g.age === age);
            if (!ageGroupData) return;

            const event = ageGroupData.genders[gender].events.find(e => e.name === eventName);
            if (!event) return;

            const times = event[course];
            const qualification = getQualification(value, times);

            // Highlight the appropriate standard cell (if any)
            // Row already has light gray background from 'has-value' class
            if (qualification === 'a') {
                const aCell = Array.from(standardCells).find(cell => cell.dataset.standard === 'a');
                if (aCell) {
                    aCell.classList.add('met', 'met-a');
                }
                row.classList.add('met-a');
            } else if (qualification === 'b-plus') {
                const bPlusCell = Array.from(standardCells).find(cell => cell.dataset.standard === 'b-plus');
                if (bPlusCell) {
                    bPlusCell.classList.add('met', 'met-b-plus');
                }
                row.classList.add('met-b-plus');
            } else if (qualification === 'b') {
                const bCell = Array.from(standardCells).find(cell => cell.dataset.standard === 'b');
                if (bCell) {
                    bCell.classList.add('met', 'met-b');
                }
                row.classList.add('met-b');
            }
            // If qualification === 'none', just the row gray background shows (no cell highlighting)
        }

        // Get qualification level (returns 'a', 'b-plus', 'b', or 'none')
        function getQualification(userTime, standards) {
            const userSeconds = timeToSeconds(userTime);
            if (userSeconds === null) return null;

            const aTime = standards.A ? timeToSeconds(standards.A) : null;
            const bPlusTime = standards['B+'] ? timeToSeconds(standards['B+']) : null;
            const bTime = standards.B ? timeToSeconds(standards.B) : null;

            // Lower times are better in swimming
            if (aTime !== null && userSeconds <= aTime) {
                return 'a';
            } else if (bPlusTime !== null && userSeconds <= bPlusTime) {
                return 'b-plus';
            } else if (bTime !== null && userSeconds <= bTime) {
                return 'b';
            } else {
                return 'none';
            }
        }

        // Convert time string to seconds
        function timeToSeconds(timeStr) {
            if (!timeStr) return null;

            timeStr = timeStr.trim();

            // Format: MM:SS.MS or SS.MS
            const parts = timeStr.split(':');
            let minutes = 0;
            let seconds = 0;

            if (parts.length === 2) {
                // MM:SS.MS format
                minutes = parseFloat(parts[0]) || 0;
                seconds = parseFloat(parts[1]) || 0;
            } else if (parts.length === 1) {
                // SS.MS format
                seconds = parseFloat(parts[0]) || 0;
            } else {
                return null;
            }

            return minutes * 60 + seconds;
        }

        // Random footer phrases
        function setRandomFooterPhrase() {
            const phrases = [
                'Made with <span class="heart">‚ù§Ô∏è</span> in war-torn PDX',
                'Made with <span class="heart">‚ù§Ô∏è</span> while PDX is aflame',
                'Built with <span class="heart">‚ù§Ô∏è</span> and the bravery to venture into PDX streets',
                'Made with <span class="heart">‚ù§Ô∏è</span> between pickleball games in war-ravaged PDX',
                'Crafted with <span class="heart">‚ù§Ô∏è</span> from the front lines of PDX',
                'Freshly brewed with <span class="heart">‚ù§Ô∏è</span> and Courier Coffee',
                'Finely tuned with <span class="heart">‚ù§Ô∏è</span> and Blue Star donuts',
                'Bravely coded with <span class="heart">‚ù§Ô∏è</span> from the epicenter of the PDX war zone',
                'Banged out with <span class="heart">‚ù§Ô∏è</span> and used gear from Revival Drums PDX',
                'Shamelessly sponsored with <span class="heart">‚ù§Ô∏è</span> by [YOUR COMPANY HERE]'
            ];

            const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
            const footerElement = document.getElementById('footerPhrase');
            if (footerElement) {
                footerElement.innerHTML = randomPhrase;
            }
        }

        // Initialize app on load
        loadData();
        setRandomFooterPhrase();
    </script>
</body>
</html>
